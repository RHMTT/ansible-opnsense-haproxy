---
# tasks file for local.maj.opnsense.haproxy
- name: Manage opnsense haproxy acls
  opnsense_haproxy_acl:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    acl_state: '{{ item.value.state | default("present") }}'
    acl_name: '{{ item.key }}'
    acl_description: '{{ item.value.description | default("") }}'
    acl_expression: '{{ item.value.expression }}'
    acl_negate: '{{ item.value.negate | default(False) }}'
    acl_hdr_beg: '{{ item.value.hdr_beg | default("") }}'
    acl_hdr_end: '{{ item.value.hdr_end | default("") }}'
    acl_hdr: '{{ item.value.hdr | default("") }}'
    acl_hdr_reg: '{{ item.value.hdr_reg | default("") }}'
    acl_hdr_sub: '{{ item.value.hdr_sub | default("") }}'
    acl_path_beg: '{{ item.value.path_beg | default("") }}'
    acl_path_end: '{{ item.value.path_end | default("") }}'
    acl_path: '{{ item.value.path | default("") }}'
    acl_path_reg: '{{ item.value.path_reg | default("") }}'
    acl_path_dir: '{{ item.value.path_dir | default("") }}'
    acl_path_sub: '{{ item.value.path_sub | default("") }}'
    acl_url_param: '{{ item.value.url_param | default("") }}'
    acl_url_param_value: '{{ item.value.url_param_value | default("") }}'
    acl_ssl_c_verify_code: '{{ item.value.ssl_c_verify_code | default("") }}'
    acl_ssl_c_ca_commonname: '{{ item.value.ssl_c_ca_commonname | default("") }}'
    acl_src: '{{ item.value.src | default("") }}'
    acl_src_bytes_in_rate_comparison: '{{ item.value.src_bytes_in_rate_comparison | default("gt") }}'
    acl_src_bytes_in_rate: '{{ item.value.src_bytes_in_rate | default("") }}'
    acl_src_bytes_out_rate_comparison: '{{ item.value.src_bytes_out_rate_comparison | default("gt") }}'
    acl_src_bytes_out_rate: '{{ item.value.src_bytes_out_rate | default("") }}'
    acl_src_conn_cnt_comparison: '{{ item.value.src_conn_cnt_comparison | default("gt") }}'
    acl_src_conn_cnt: '{{ item.value.src_conn_cnt | default("") }}'
    acl_src_conn_rate_comparison: '{{ item.value.src_conn_rate_comparison | default("gt") }}'
    acl_src_conn_rate: '{{ item.value.src_conn_rate | default("") }}'
    acl_src_http_err_cnt_comparison: '{{ item.value.src_http_err_cnt_comparison | default("gt") }}'
    acl_src_http_err_cnt: '{{ item.value.src_http_err_cnt | default("") }}'
    acl_src_http_err_rate_comparison: '{{ item.value.src_http_err_rate_comparison | default("gt") }}'
    acl_src_http_err_rate: '{{ item.value.src_http_err_rate | default("") }}'
    acl_src_http_req_rate_comparison: '{{ item.value.src_http_req_rate_comparison | default("gt") }}'
    acl_src_http_req_rate: '{{ item.value.src_http_req_rate | default("") }}'
    acl_src_kbytes_in_comparison: '{{ item.value.src_kbytes_in_comparison | default("gt") }}'
    acl_src_kbytes_in: '{{ item.value.src_kbytes_in | default("") }}'
    acl_src_kbytes_out_comparison: '{{ item.value.src_kbytes_out_comparison | default("gt") }}'
    acl_src_kbytes_out: '{{ item.value.src_kbytes_out | default("") }}'
    acl_src_port_comparison: '{{ item.value.src_port_comparison | default("gt") }}'
    acl_src_port: '{{ item.value.src_port | default("") }}'
    acl_src_sess_cnt_comparison: '{{ item.value.src_sess_cnt_comparison | default("gt") }}'
    acl_src_sess_cnt: '{{ item.value.src_sess_cnt | default("") }}'
    acl_nbsrv: '{{ item.value.nbsrv | default("") }}'
    acl_nbsrv_backend: '{{ item.value.nbsrv_backend | default("") }}'
    acl_ssl_fc_sni: '{{ item.value.ssl_fc_sni | default("") }}'
    acl_ssl_sni: '{{ item.value.ssl_sni | default("") }}'
    acl_ssl_sni_sub: '{{ item.value.ssl_sni_sub | default("") }}'
    acl_ssl_sni_beg: '{{ item.value.ssl_sni_beg | default("") }}'
    acl_ssl_sni_end: '{{ item.value.ssl_sni_end | default("") }}'
    acl_ssl_sni_reg: '{{ item.value.ssl_sni_reg | default("") }}'
    acl_custom_acl: '{{ item.value.custom_acl | default("") }}'
    acl_value: '{{ item.value.value | default("") }}'
    acl_query_backend: '{{ item.value.query_backend | default("") }}'
    acl_allowed_users: '{{ item.value.allowed_users | default([]) }}'
    acl_allowed_groups: '{{ item.value.allowed_groups | default([]) }}'
  loop: '{{ opnsense_haproxy_acls | dict2items }}'
  
- name: Manage opnsense haproxy cpu affinity rules
  opnsense_haproxy_cpu:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    cpu_state: '{{ item.value.state | default("present") }}'
    cpu_enabled: '{{ item.value.enabled | default(True) }}'
    cpu_name: '{{ item.key }}'
    cpu_process_id: '{{ item.value.process_id | default("all") }}'
    cpu_thread_id: '{{ item.value.thread_id | default("all") }}'
    cpu_cpu_id: '{{ item.value.cpu_id | default("all") }}'
  loop: '{{ opnsense_haproxy_cpus | default({}) | dict2items }}'

- name: Manage opnsense haproxy errorfiles
  opnsense_haproxy_errorfile:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    errorfile_name: '{{ item.key }}'
    errorfile_code: '{{ item.value.code }}'
    errorfile_description: '{{ item.value.description | default("") }}'
    errorfile_content: '{{ item.value.content | default("") }}'
    errorfile_state: '{{ item.value.state | default("present") }}'
  loop: '{{ opnsense_haproxy_errorfiles | default({}) | dict2items }}'

- name: Manage opnsense haproxy healthchecks
  opnsense_haproxy_healthcheck:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    healthcheck_state: '{{ item.value.state | default("present") }}'
    healthcheck_name: '{{ item.key }}'
    healthcheck_description: '{{ item.value.description | default("") }}'
    healthcheck_type: '{{ item.value.type | default("http") }}'
    healthcheck_interval: '{{ item.value.interval | default("2s") }}'
    healthcheck_force_ssl: '{{ item.value.force_ssl | default(False) }}'
    healthcheck_checkport: '{{ item.value.checkport | default("") }}'
    healthcheck_http_method: '{{ item.value.http_method | default("options") }}'
    healthcheck_http_uri: '{{ item.value.http_uri | default("/") }}'
    healthcheck_http_version: '{{ item.value.http_version | default("http10") }}'
    healthcheck_http_host: '{{ item.value.http_host | default("localhost") }}'
    healthcheck_http_expression: '{{ item.value.http_expression | default("") }}'
    healthcheck_http_expression_enabled: '{{ item.value.http_expression_enabled | default(False) }}'
    healthcheck_http_negate: '{{ item.value.http_negate | default(False) }}'
    healthcheck_http_value: '{{ item.value.http_value | default("") }}'
    healthcheck_tcp_enabled: '{{ item.value.tcp_enabled | default(False) }}'
    healthcheck_tcp_send_value: '{{ item.value.tcp_send_value | default("") }}'
    healthcheck_tcp_match_type: '{{ item.value.tcp_match_type | default("") }}'
    healthcheck_tcp_negate: '{{ item.value.tcp_negate | default(False) }}'
    healthcheck_tcp_match_value: '{{ item.value.tcp_match_value | default("") }}'
    healthcheck_agent_port: '{{ item.value.agent_port | default("") }}'
    healthcheck_mysql_user: '{{ item.value.mysql_user | default("") }}'
    healthcheck_mysql_post41: '{{ item.value.mysql_post41 | default(False) }}'
    healthcheck_pgsql_user: '{{ item.value.pgsql_user | default("") }}'
    healthcheck_smtp_domain: '{{ item.value.smtp_domain | default("") }}'
    healthcheck_esmtp_domain: '{{ item.value.esmtp_domain | default("") }}'
    healthcheck_db_user: '{{ item.value.db_user | default("") }}'
  loop: '{{ opnsense_haproxy_healthchecks | default({}) | dict2items }}'

- name: Manage opnsense haproxy lua scripts
  opnsense_haproxy_lua:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    lua_name: '{{ item.key }}'
    lua_enabled: '{{ item.value.enabled | default(True) }}'
    lua_description: '{{ item.value.description | default("") }}'
    lua_content: '{{ item.value.content | default("") }}'
    lua_state: '{{ item.value.state | default("present") }}'
  loop: '{{ opnsense_haproxy_luas | default({}) | dict2items }}'

- name: Manage opnsense haproxy servers
  opnsense_haproxy_server:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    server_state: '{{ item.value.state | default("present") }}'
    server_enabled: '{{ item.value.enabled | default(True) }}'
    server_name: '{{ item.key }}'
    server_description: '{{ item.value.description | default("") }}'
    server_address: '{{ item.value.address }}'
    server_port: '{{ item.value.port }}'
    server_checkport: '{{ item.value.port | default("") }}'
    server_mode: '{{ item.value.mode | default("active") }}'
    server_ssl: '{{ item.value.ssl | default(False) }}'
    server_ssl_verify: '{{ item.value.ssl_verify | default(True) }}'
    server_ssl_ca: '{{ item.value.ssl_ca | default([]) }}'
    server_ssl_crl: '{{ item.value.ssl_crl | default("") }}'
    server_ssl_client_certificate: '{{ item.value.ssl_client_certificate | default("") }}'
    server_weight: '{{ item.value.weight | default("") }}'
    server_check_interval: '{{ item.value.check_interval | default("") }}'
    server_check_down_interval: '{{ item.value.check_down_interval | default("") }}'
    server_source: '{{ item.value.source | default("") }}'
    server_advanced: '{{ item.value.advanced | default("") }}'
  loop: '{{ opnsense_haproxy_servers | default({}) | dict2items }}'

- name: Manage opnsense haproxy users
  opnsense_haproxy_user:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    user_state: '{{ item.value.state | default("present") }}'
    user_name: '{{ item.key }}'
    user_password: '{{ item.value.password }}'
    user_description: '{{ item.value.description | default("") }}'
    user_enabled: '{{ item.value.enabled | default(True) }}'
  loop: '{{ opnsense_haproxy_users | default({}) | dict2items }}'

- name: Manage opnsense haproxy user groups
  opnsense_haproxy_group:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    group_name: '{{ item.key }}'
    group_enabled: '{{ item.value.enabled | default(True) }}'
    group_description: '{{ item.value.description | default("") }}'
    group_members: '{{ item.value.members | default([]) }}'
    group_state: '{{ item.value.state | default("present") }}'
  loop: '{{ opnsense_haproxy_groups | default({}) | dict2items }}'

- name: Manage opnsense haproxy backends
  opnsense_haproxy_backend:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    backend_state: '{{ item.value.state | default("present") }}'
    backend_enabled: '{{ item.value.enabled | default(True) }}'
    backend_name: '{{ item.key }}'
    backend_description: '{{ item.value.description | default("") }}'
    backend_mode: '{{ item.value.mode | default("http") }}'
    backend_algorithm: '{{ item.value.algorithm | default("source") }}'
    backend_proxy_protocol: '{{ item.value.proxy_protocol | default("") }}'
    backend_linked_servers: '{{ item.value.linked_servers | default([]) }}'
    backend_source: '{{ item.value.source | default("") }}'
    backend_health_check_enabled: '{{ item.value.health_check_enabled | default(True) }}'
    backend_health_check: '{{ item.value.health_check | default("") }}'
    backend_health_check_log_status: '{{ item.value.health_check_log_status | default(False) }}'
    backend_check_interval: '{{ item.value.check_interval | default("") }}'
    backend_check_down_interval: '{{ item.value.check_down_interval | default("") }}'
    backend_health_check_fall: '{{ item.value.health_check_fall | default("") }}'
    backend_health_check_rise: '{{ item.value.health_check_rise | default("") }}'
    backend_persistence: '{{ item.value.persistence | default("sticktable") }}'
    backend_persistence_cookie_mode: '{{ item.value.persistence_cookie_mode | default("piggyback") }}'
    backend_persistence_cookie_name: '{{ item.value.persistence_cookie_name | default("SRVCOOKIE") }}'
    backend_persistence_strip_quotes: '{{ item.value.persistence_strip_quotes | default(True) }}'
    backend_stickiness_pattern: '{{ item.value.stickiness_pattern | default("sourceipv4") }}'
    backend_stickiness_data_types: '{{ item.value.stickiness_data_types | default([]) }}'
    backend_stickiness_expire: '{{ item.value.stickiness_expire | default("30m") }}'
    backend_stickiness_size: '{{ item.value.stickiness_size | default("50k") }}'
    backend_stickiness_cookie_name: '{{ item.value.stickiness_cookie_name | default("") }}'
    backend_stickiness_cookie_length: '{{ item.value.stickiness_cookie_length | default("") }}'
    backend_stickiness_conn_rate_period: '{{ item.value.stickiness_conn_rate_period | default("10s") }}'
    backend_stickiness_sess_rate_period: '{{ item.value.stickiness_sess_rate_period | default("10s") }}'
    backend_stickiness_http_req_rate_period: '{{ item.value.stickiness_http_req_rate_period | default("10s") }}'
    backend_stickiness_http_err_rate_period: '{{ item.value.stickiness_http_err_rate_period | default("10s") }}'
    backend_stickiness_bytes_in_rate_period: '{{ item.value.stickiness_bytes_in_rate_period | default("1m") }}'
    backend_stickiness_bytes_out_rate_period: '{{ item.value.stickiness_bytes_out_rate_period | default("1m") }}'
    backend_basic_auth_enabled: '{{ item.value.basic_auth_enabled | default(False) }}'
    backend_basic_auth_users: '{{ item.value.basic_auth_users | default([]) }}'
    backend_basic_auth_groups: '{{ item.value.basic_auth_groups | default([]) }}'
    backend_tuning_timeout_connect: '{{ item.value.tuning_timeout_connect | default("") }}'
    backend_tuning_timeout_check: '{{ item.value.tuning_timeout_check | default("") }}'
    backend_tuning_timeout_server: '{{ item.value.tuning_timeout_server | default("") }}'
    backend_tuning_retries: '{{ item.value.backend_tuning_retries | default("") }}'
    backend_custom_options: '{{ item.value.custom_options | default("") }}'
    backend_tuning_default_server: '{{ item.value.tuning_default_server | default("") }}'
    backend_tuning_no_port: '{{ item.value.tuning_no_port | default(False) }}'
    backend_tuning_http_reuse: '{{ item.value.tuning_http_reuse | default("never") }}'
    backend_linked_actions: '{{ item.value.linked_actions | default([]) }}'
    backend_linked_errorfiles: '{{ item.value.linked_errorfiles | default([]) }}'
  loop: '{{ opnsense_haproxy_backends | default({}) | dict2items }}'

- name: Manage opnsense haproxy actions
  opnsense_haproxy_action:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    action_state: '{{ item.value.state | default("present") }}'
    action_name: '{{ item.key }}'
    action_description: '{{ item.value.description | default("") }}'
    action_type: '{{ item.value.type }}'
    action_linked_acls: '{{ item.value.linked_acls | default([]) }}'
    action_test_type: '{{ item.value.test_type | default("if") }}'
    action_operator: '{{ item.value.operator | default("and") }}'
    action_value: '{{ item.value.value }}'
  loop: '{{ opnsense_haproxy_actions | default({}) | dict2items }}'

- name: Manage opnsense haproxy frontends
  opnsense_haproxy_frontend:
    api_url: '{{ opnsense_api_url }}'
    api_key: '{{ opnsense_api_key }}'
    api_secret: '{{ opnsense_api_secret }}'
    frontend_state: '{{ item.value.state | default("present") }}'
    frontend_enabled: '{{ item.value.enabled | default(True) }}'
    frontend_name: '{{ item.key }}'
    frontend_description: '{{ item.value.description | default("") }}'
    frontend_bind: '{{ item.value.bind | default([]) }}'
    frontend_bind_options: '{{ item.value.bind_options | default("") }}'
    frontend_mode: '{{ item.value.mode | default("http") }}'
    frontend_default_backend: '{{ item.value.default_backend | default("none") }}'
    frontend_ssl_enabled: '{{ item.value.ssl_enabled | default(False) }}'
    frontend_ssl_certificates: '{{ item.value.ssl_certificates | default([]) }}'
    frontend_ssl_default_certificate: '{{ item.value.ssl_default_certificate | default("") }}'
    frontend_ssl_custom_options: '{{ item.value.ssl_custom_options | default("") }}'
    frontend_ssl_advanced_enabled: '{{ item.value.ssl_advanced_enabled | default(False) }}'
    frontend_ssl_bind_options: '{{ item.value.ssl_bind_options | default([]) }}'
    frontend_ssl_cipher_list: '{{ item.value.ssl_cipher_list | default("ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256") }}'
    frontend_ssl_http2_enabled: '{{ item.value.ssl_http2_enabled | default(False) }}'
    frontend_ssl_hsts_enabled: '{{ item.value.ssl_hsts_enabled | default(True) }}'
    frontend_ssl_hsts_include_sub_domains: '{{ item.value.ssl_hsts_include_sub_domains | default(False) }}'
    frontend_ssl_hsts_preload: '{{ item.value.ssl_hsts_preload | default(False) }}'
    frontend_ssl_hsts_max_age: '{{ item.value.ssl_hsts_max_age | default("15768000") }}'
    frontend_ssl_client_auth_enabled: '{{ item.value.ssl_client_auth_enabled | default(False) }}'
    frontend_ssl_client_auth_verify: '{{ item.value.ssl_client_auth_verify | default("none") }}'
    frontend_ssl_client_auth_cas: '{{ item.value.ssl_client_auth_cas | default([]) }}'
    frontend_ssl_client_auth_crls: '{{ item.value.ssl_client_auth_crls | default([]) }}'
    frontend_basic_auth_enabled: '{{ item.value.basic_auth_enabled | default(False) }}'
    frontend_basic_auth_users: '{{ item.value.basic_auth_users | default([]) }}'
    frontend_basic_auth_groups: '{{ item.value.basic_auth_groups | default([]) }}'
    frontend_tuning_max_connections: '{{ item.value.tuning_max_connections | default("") }}'
    frontend_tuning_timeout_client: '{{ item.value.tuning_timeout_client | default("") }}'
    frontend_tuning_timeout_http_req: '{{ item.value.tuning_timeout_http_req | default("") }}'
    frontend_tuning_timeout_http_keep_alive: '{{ item.value.tuning_timeout_http_keep_alive | default("") }}'
    frontend_linked_cpu_affinity_rules: '{{ item.value.linked_cpu_affinity_rules | default([]) }}'
    frontend_logging_dont_log_null: '{{ item.value.logging_dont_log_null | default(False) }}'
    frontend_logging_dont_log_normal: '{{ item.value.logging_dont_log_normal | default(False) }}'
    frontend_logging_log_separate_errors: '{{ item.value.logging_log_separate_errors | default(False) }}'
    frontend_logging_detailed_log: '{{ item.value.logging_detailed_log | default(False) }}'
    frontend_logging_socket_stats: '{{ item.value.logging_socket_stats | default(False) }}'
    frontend_stickiness_pattern: '{{ item.value.stickiness_pattern | default("ipv4") }}'
    frontend_stickiness_data_types: '{{ item.value.stickiness_data_types | default([]) }}'
    frontend_stickiness_expire: '{{ item.value.stickiness_expire | default("30m") }}'
    frontend_stickiness_size: '{{ item.value.stickiness_size | default("50k") }}'
    frontend_stickiness_counter: '{{ item.value.stickiness_counter | default(True) }}'
    frontend_stickiness_counter_key: '{{ item.value.stickiness_counter_key | default("src") }}'
    frontend_stickiness_length: '{{ item.value.stickiness_length | default("") }}'
    frontend_stickiness_conn_rate_period: '{{ item.value.stickiness_conn_rate_period | default("10s") }}'
    frontend_stickiness_sess_rate_period: '{{ item.value.stickiness_sess_rate_period | default("10s") }}'
    frontend_stickiness_http_req_rate_period: '{{ item.value.stickiness_http_req_rate_period | default("10s") }}'
    frontend_stickiness_http_err_rate_period: '{{ item.value.stickiness_http_err_rate_period | default("10s") }}'
    frontend_stickiness_bytes_in_rate_period: '{{ item.value.stickiness_bytes_in_rate_period | default("1m") }}'
    frontend_stickiness_bytes_out_rate_period: '{{ item.value.stickiness_bytes_out_rate_period | default("1m") }}'
    frontend_forward_for: '{{ item.value.forward_for | default(False) }}'
    frontend_connection_behaviour: '{{ item.value.connection_behaviour | default("http-keep-alive") }}'
    frontend_custom_options: '{{ item.value.custom_options | default("") }}'
    frontend_linked_actions: '{{ item.value.linked_actions | default([]) }}'
    frontend_linked_errorfiles: '{{ item.value.linked_errorfiles | default([]) }}'
  loop: '{{ opnsense_haproxy_frontends | default({}) | dict2items }}'
